generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id                     String                @id @default(cuid())
  name                   String
  address                String?
  cnpj                   String?
  createdAt              DateTime              @default(now())
  daysRemainingInTrial   Int?
  email                  String?
  isActive               Boolean               @default(true)
  isTrialActive          Boolean               @default(false)
  lastActivity           DateTime?
  maxProjects            Int?
  maxStorage             Int?
  maxUsers               Int?
  notes                  String?
  phone                  String?
  pointsCount            Int                   @default(0)
  projectsCount          Int                   @default(0)
  storageUsed            Int                   @default(0)
  subscriptionExpiryDate DateTime?
  subscriptionPlan       String?
  subscriptionStatus     String?
  trialEndDate           DateTime?
  trialStartDate         DateTime?
  usersCount             Int                   @default(0)
  locations              Location[]
  projects               Project[]
  users                  User[]
  backupRecords          BackupRecord[]
  companySettings        CompanySettings?
  files                  File[]
  notificationSettings   NotificationSettings?
  saasActivityLog        SaasActivityLog[]
  subscriptionHistory    SubscriptionHistory[]
  subscriptions          Subscription[]
  syncQueue              SyncQueue[]
  teams                  Team[]
  usageAnalytics         UsageAnalytics[]
  usageLimits            UsageLimits?
  userInvitations        UserInvitation[]
}

model User {
  id                       String                @id @default(cuid())
  name                     String
  email                    String?               @unique
  password                 String?
  role                     UserRole
  active                   Boolean               @default(true)
  createdAt                DateTime              @default(now()) @map("created_at")
  updatedAt                DateTime              @updatedAt @map("updated_at")
  lastLogin                DateTime?             @map("last_login_at")
  phone                    String?
  companyId                String
  image                    String?
  emailVerified            DateTime?
  createdProjects          Project[]             @relation("CreatedByUser")
  company                  Company               @relation(fields: [companyId], references: [id])
  createdAnchorPoints      AnchorPoint[]         @relation("CreatedByUser")
  lastModifiedAnchorPoints AnchorPoint[]         @relation("LastModifiedByUser")
  archivedAnchorPoints     AnchorPoint[]         @relation("ArchivedByUser")
  supervisedTests          AnchorTest[]          @relation("SupervisedTests")
  auditLogs                AuditLog[]
  files                    File[]
  notifications            Notification[]
  passwordResets           PasswordReset[]
  saasActivityLogs         SaasActivityLog[]
  subscriptionHistoryAdmin SubscriptionHistory[] @relation("SubscriptionHistoryAdmin")
  syncQueue                SyncQueue[]
  syncStatuses             SyncStatus[]
  systemLogs               SystemLog[]
  teamMemberships          TeamMember[]
  grantedPermissions       UserPermission[]      @relation("GrantedPermissions")
  userPermissions          UserPermission[]
  userPreferences          UserPreferences?
  userSessions             UserSession[]
  accounts                 Account[]
  sessions                 Session[]
  inspectionsAsEngineer    FacadeInspection[]    @relation("InspectionEngineer")
  createdInspections       FacadeInspection[]    @relation("InspectionCreator")
  createdPathologyMarkers  PathologyMarker[]     @relation("PathologyMarkerCreator")
  reportsAsEngineer        InspectionReport[]    @relation("ReportEngineer")
  approvedReports          InspectionReport[]    @relation("ReportApprover")
}

model Location {
  id          String   @id @default(cuid())
  name        String
  markerShape String
  companyId   String
  projectId   String?  @map("project_id")
  markerColor String?
  company     Company  @relation(fields: [companyId], references: [id])
  project     Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Project {
  id                           String                  @id @default(cuid())
  name                         String
  floorPlanImages              String[]
  deleted                      Boolean                 @default(false)
  createdAt                    DateTime                @default(now())
  updatedAt                    DateTime                @updatedAt
  companyId                    String
  createdByUserId              String
  obraAddress                  String?
  obraCEP                      String?
  obraCNPJ                     String?
  contratanteName              String?
  contratanteAddress           String?
  contratanteCEP               String?
  cnpjContratado               String?
  contato                      String?
  valorContrato                String?
  dataInicio                   String?
  dataTermino                  String?
  responsavelTecnico           String?
  registroCREA                 String?
  tituloProfissional           String?
  numeroART                    String?
  rnp                          String?
  cargaDeTestePadrao           String?
  tempoDeTestePadrao           String?
  engenheiroResponsavelPadrao  String?
  dispositivoDeAncoragemPadrao String?
  locations                    Location[]
  company                      Company                 @relation(fields: [companyId], references: [id])
  createdBy                    User                    @relation("CreatedByUser", fields: [createdByUserId], references: [id])
  anchorPoints                 AnchorPoint[]
  photos                       Photo[]
  publicSettings               ProjectPublicSettings?
  teamPermissions              ProjectTeamPermission[]
  floorPlans                   FloorPlan[]
  facadeInspections            FacadeInspection[]
  pathologyCategories          PathologyCategory[]
}

model SubscriptionPlan {
  id            String         @id
  name          String
  description   String?
  priceMonthly  Decimal        @map("price_monthly") @db.Decimal(10, 2)
  priceYearly   Decimal?       @map("price_yearly") @db.Decimal(10, 2)
  maxUsers      Int?           @map("max_users")
  maxProjects   Int?           @map("max_projects")
  maxPoints     Int?           @map("max_points")
  maxStorageGb  Int?           @default(10) @map("max_storage_gb")
  features      Json           @default("{}")
  active        Boolean        @default(true)
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  subscriptions Subscription[]

  @@map("subscription_plans")
}

model Subscription {
  id                 String             @id @default(cuid())
  companyId          String             @map("company_id")
  planId             String             @map("plan_id")
  status             SubscriptionStatus @default(trialing)
  currentPeriodStart DateTime           @map("current_period_start")
  currentPeriodEnd   DateTime           @map("current_period_end")
  trialStart         DateTime?          @map("trial_start")
  trialEnd           DateTime?          @map("trial_end")
  cancelAt           DateTime?          @map("cancel_at")
  canceledAt         DateTime?          @map("canceled_at")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  payments           Payment[]
  company            Company            @relation(fields: [companyId], references: [id])
  plan               SubscriptionPlan   @relation(fields: [planId], references: [id])

  @@map("subscriptions")
}

model Payment {
  id             String        @id @default(cuid())
  subscriptionId String        @map("subscription_id")
  amount         Decimal       @db.Decimal(10, 2)
  currency       String        @default("BRL")
  status         PaymentStatus @default(pending)
  paymentMethod  String        @map("payment_method")
  externalId     String?       @map("external_id")
  externalData   Json?         @map("external_data")
  paidAt         DateTime?     @map("paid_at")
  failedAt       DateTime?     @map("failed_at")
  refundedAt     DateTime?     @map("refunded_at")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  subscription   Subscription  @relation(fields: [subscriptionId], references: [id])

  @@map("payments")
}

model AnchorPoint {
  id                      String       @id @default(cuid())
  projectId               String       @map("project_id")
  numeroPonto             String       @map("numero_ponto")
  localizacao             String
  foto                    String?
  numeroLacre             String?      @map("numeroLacre")
  tipoEquipamento         String?      @map("tipo_equipamento")
  dataInstalacao          String?      @map("data_instalacao")
  frequenciaInspecaoMeses Int?         @map("frequencia_inspecao_meses")
  observacoes             String?
  posicaoX                Float        @map("posicao_x")
  posicaoY                Float        @map("posicao_y")
  dataHora                DateTime     @default(now()) @map("data_hora")
  status                  String       @default("NÃ£o Testado")
  createdByUserId         String?      @map("created_by_user_id")
  lastModifiedByUserId    String?      @map("last_modified_by_user_id")
  archived                Boolean      @default(false)
  archivedAt              DateTime?    @map("archived_at")
  archivedById            String?      @map("archived_by_id")
  floorPlanId             String?      @map("floor_plan_id")

  // PWA Sync fields
  photoUploadPending      Boolean      @default(false) @map("photo_upload_pending")
  lastSyncedAt            DateTime?    @map("last_synced_at")
  syncStatus              String?      @default("synced") @map("sync_status")

  // GPS fields
  gpsLatitude             Float?       @map("gps_latitude")
  gpsLongitude            Float?       @map("gps_longitude")
  gpsAccuracy             Float?       @map("gps_accuracy")
  gpsTimestamp            DateTime?    @map("gps_timestamp")

  // Inspection tracking fields
  nextInspectionDate      DateTime?    @map("next_inspection_date")
  inspectionInterval      Int?         @default(180) @map("inspection_interval") // dias
  lastInspectionDate      DateTime?    @map("last_inspection_date")

  // Relations
  createdBy               User?        @relation("CreatedByUser", fields: [createdByUserId], references: [id])
  lastModifiedBy          User?        @relation("LastModifiedByUser", fields: [lastModifiedByUserId], references: [id])
  archivedBy              User?        @relation("ArchivedByUser", fields: [archivedById], references: [id])
  project                 Project      @relation(fields: [projectId], references: [id])
  floorPlan               FloorPlan?   @relation(fields: [floorPlanId], references: [id], onDelete: SetNull)
  anchorTests             AnchorTest[]
  photos                  Photo[]

  @@map("anchor_points")
}

model AnchorTest {
  id                      String      @id @default(cuid())
  pontoId                 String      @map("ponto_id")
  dataHora                DateTime    @default(now()) @map("data_hora")
  resultado               String
  carga                   String
  tempo                   String
  tecnico                 String
  observacoes             String?
  fotoTeste               String?     @map("foto_teste")
  fotoPronto              String?     @map("foto_pronto")
  dataFotoPronto          String?     @map("data_foto_pronto")

  // Compliance fields
  regulatoryStandard      String?     @map("regulatory_standard") // ex: "ABNT NBR 15475"
  complianceStatus        String?     @default("compliant") @map("compliance_status")
  certificationNumber     String?     @map("certification_number")

  // Equipment fields
  equipmentUsed           String?     @map("equipment_used")
  equipmentSerialNumber   String?     @map("equipment_serial_number")
  equipmentCalibration    DateTime?   @map("equipment_calibration")

  // Environmental fields
  weatherConditions       String?     @map("weather_conditions")
  temperature             Float?      @map("temperature")
  humidity                Float?      @map("humidity")

  // Technician credentials fields
  technicianLicense       String?     @map("technician_license")
  technicianCertification String?     @map("technician_certification")
  supervisorId            String?     @map("supervisor_id")

  // Relations
  anchorPoint             AnchorPoint @relation(fields: [pontoId], references: [id])
  supervisor              User?       @relation("SupervisedTests", fields: [supervisorId], references: [id])

  @@map("anchor_tests")
}

model Photo {
  id               String      @id @default(cuid())
  fileName         String      @map("file_name")
  filePath         String?     @map("file_path")
  publicUrl        String?     @map("public_url")
  projectId        String      @map("project_id")
  pontoId          String      @map("ponto_id")
  pontoNumero      String      @map("ponto_numero")
  pontoLocalizacao String      @map("ponto_localizacao")
  type             String
  capturedAt       DateTime    @map("captured_at")
  uploadedAt       DateTime?   @map("uploaded_at")
  createdAt        DateTime    @default(now()) @map("created_at")
  uploaded         Boolean     @default(false)
  fileSize         Int?        @map("file_size")
  anchorPoint      AnchorPoint @relation(fields: [pontoId], references: [id])
  project          Project     @relation(fields: [projectId], references: [id])

  @@index([projectId])
  @@index([pontoId])
  @@index([uploaded])
  @@map("photos")
}

model File {
  id           String   @id @default(cuid())
  filename     String
  originalName String   @map("original_name")
  mimeType     String   @map("mime_type")
  size         Int
  url          String?
  uploaded     Boolean  @default(false)
  companyId    String   @map("company_id")
  userId       String?  @map("user_id")
  createdAt    DateTime @default(now()) @map("created_at")
  company      Company  @relation(fields: [companyId], references: [id])
  user         User?    @relation(fields: [userId], references: [id])

  @@map("files")
}

model SyncQueue {
  id        String    @id @default(cuid())
  operation String
  tableName String    @map("table_name")
  recordId  String    @map("record_id")
  data      Json
  status    String    @default("pending")
  retries   Int       @default(0)
  error     String?
  companyId String    @map("company_id")
  userId    String?   @map("user_id")
  createdAt DateTime  @default(now()) @map("created_at")
  syncedAt  DateTime? @map("synced_at")
  company   Company   @relation(fields: [companyId], references: [id])
  user      User?     @relation(fields: [userId], references: [id])

  @@map("sync_queue")
}

model UserSession {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  sessionToken String   @unique @map("session_token")
  refreshToken String   @unique @map("refresh_token")
  expiresAt    DateTime @map("expires_at")
  ipAddress    String   @map("ip_address")
  userAgent    String   @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

model UserInvitation {
  id         String    @id @default(cuid())
  companyId  String    @map("company_id")
  email      String
  role       UserRole
  invitedBy  String    @map("invited_by")
  token      String    @unique
  expiresAt  DateTime  @map("expires_at")
  acceptedAt DateTime? @map("accepted_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  company    Company   @relation(fields: [companyId], references: [id])

  @@map("user_invitations")
}

model UsageLimits {
  id            String   @id @default(cuid())
  companyId     String   @unique @map("company_id")
  usersCount    Int      @default(0) @map("users_count")
  projectsCount Int      @default(0) @map("projects_count")
  pointsCount   Int      @default(0) @map("points_count")
  storageUsedGb Decimal  @default(0) @map("storage_used_gb") @db.Decimal(10, 2)
  updatedAt     DateTime @updatedAt @map("updated_at")
  company       Company  @relation(fields: [companyId], references: [id])

  @@map("usage_limits")
}

model PasswordReset {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id])

  @@map("password_resets")
}

model AuditLog {
  id            String   @id @default(cuid())
  tableName     String   @map("table_name")
  recordId      String   @map("record_id")
  operation     String
  oldValues     Json?    @map("old_values")
  newValues     Json?    @map("new_values")
  changedFields String[] @map("changed_fields")
  userId        String?  @map("user_id")
  sessionId     String?  @map("session_id")
  timestamp     DateTime @default(now())
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")
  user          User?    @relation(fields: [userId], references: [id])

  @@map("audit_log")
}

model SyncStatus {
  id         String   @id @default(cuid())
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  userId     String   @map("user_id")
  deviceId   String   @map("device_id")
  syncStatus String   @map("sync_status")
  retryCount Int      @default(0) @map("retry_count")
  lastError  String?  @map("last_error")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  user       User     @relation(fields: [userId], references: [id])

  @@map("sync_status")
}

model Notification {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  title     String
  message   String
  type      String
  data      Json?
  readAt    DateTime? @map("read_at")
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model UserPreferences {
  id          String   @id @default(cuid())
  userId      String   @unique @map("user_id")
  preferences Json     @default("{}")
  updatedAt   DateTime @updatedAt @map("updated_at")
  user        User     @relation(fields: [userId], references: [id])

  @@map("user_preferences")
}

model CompanySettings {
  id        String   @id @default(cuid())
  companyId String   @unique @map("company_id")
  settings  Json     @default("{}")
  updatedAt DateTime @updatedAt @map("updated_at")
  company   Company  @relation(fields: [companyId], references: [id])

  @@map("company_settings")
}

model SystemLog {
  id        String   @id @default(cuid())
  level     String
  category  String
  message   String
  context   Json?
  userId    String?  @map("user_id")
  sessionId String?  @map("session_id")
  timestamp DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@map("system_logs")
}

model SaasActivityLog {
  id           String   @id @default(cuid())
  companyId    String   @map("company_id")
  userId       String?  @map("user_id")
  activityType String   @map("activity_type")
  description  String
  metadata     Json?
  timestamp    DateTime @default(now())
  company      Company  @relation(fields: [companyId], references: [id])
  user         User?    @relation(fields: [userId], references: [id])

  @@map("saas_activity_log")
}

model UserPermission {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  permission    String
  resourceType  String?   @map("resource_type")
  resourceId    String?   @map("resource_id")
  grantedBy     String    @map("granted_by")
  grantedAt     DateTime  @default(now()) @map("granted_at")
  expiresAt     DateTime? @map("expires_at")
  grantedByUser User      @relation("GrantedPermissions", fields: [grantedBy], references: [id])
  user          User      @relation(fields: [userId], references: [id])

  @@map("user_permissions")
}

model BackupConfig {
  id              String    @id @default(cuid())
  enabled         Boolean   @default(true)
  frequency       String
  retentionDays   Int       @default(30) @map("retention_days")
  includeFiles    Boolean   @default(true) @map("include_files")
  compressBackups Boolean   @default(true) @map("compress_backups")
  encryptBackups  Boolean   @default(false) @map("encrypt_backups")
  backupPath      String    @map("backup_path")
  lastBackup      DateTime? @map("last_backup")
  nextBackup      DateTime? @map("next_backup")
  backupSize      Int?      @map("backup_size")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("backup_config")
}

model BackupRecord {
  id             String   @id @default(cuid())
  timestamp      DateTime @default(now())
  type           String
  status         String
  size           Int
  duration       Int
  error          String?
  tablesBackedUp String[] @map("tables_backed_up")
  filesCount     Int      @default(0) @map("files_count")
  companyId      String?  @map("company_id")
  createdAt      DateTime @default(now()) @map("created_at")
  company        Company? @relation(fields: [companyId], references: [id])

  @@map("backup_records")
}

model UsageAnalytics {
  id              String   @id @default(cuid())
  companyId       String   @map("company_id")
  date            String
  activeUsers     Int      @default(0) @map("active_users")
  projectsCreated Int      @default(0) @map("projects_created")
  pointsCreated   Int      @default(0) @map("points_created")
  testsPerformed  Int      @default(0) @map("tests_performed")
  photosUploaded  Int      @default(0) @map("photos_uploaded")
  storageUsed     Int      @default(0) @map("storage_used")
  syncOperations  Int      @default(0) @map("sync_operations")
  loginCount      Int      @default(0) @map("login_count")
  sessionDuration Int      @default(0) @map("session_duration")
  topFeatures     String[] @map("top_features")
  createdAt       DateTime @default(now()) @map("created_at")
  company         Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, date])
  @@map("usage_analytics")
}

model SystemHealth {
  id                String   @id @default(cuid())
  timestamp         DateTime @default(now())
  status            String
  databaseStatus    String   @map("database_status")
  storageStatus     String   @map("storage_status")
  syncStatus        String   @map("sync_status")
  backupStatus      String   @map("backup_status")
  responseTime      Int      @map("response_time")
  cpuUsage          Int      @map("cpu_usage")
  memoryUsage       Int      @map("memory_usage")
  diskUsage         Int      @map("disk_usage")
  activeConnections Int      @map("active_connections")
  queueLength       Int      @map("queue_length")
  alerts            String[]

  @@map("system_health")
}

model SubscriptionHistory {
  id            String   @id @default(cuid())
  companyId     String   @map("company_id")
  planId        String   @map("plan_id")
  action        String
  previousPlan  String?  @map("previous_plan")
  newPlan       String?  @map("new_plan")
  effectiveDate DateTime @map("effective_date")
  amount        Decimal? @db.Decimal(10, 2)
  paymentMethod String?  @map("payment_method")
  adminId       String   @map("admin_id")
  reason        String?
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")
  admin         User     @relation("SubscriptionHistoryAdmin", fields: [adminId], references: [id])
  company       Company  @relation(fields: [companyId], references: [id])

  @@map("subscription_history")
}

model Permission {
  id              String   @id @default(cuid())
  name            String   @unique
  description     String
  category        String
  actions         String[]
  ownDataOnly     Boolean  @default(false) @map("own_data_only")
  companyDataOnly Boolean  @default(true) @map("company_data_only")
  timeRestricted  Boolean  @default(false) @map("time_restricted")
  active          Boolean  @default(true)
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("permissions")
}

model Team {
  id                 String                  @id @default(cuid())
  name               String
  companyId          String                  @map("company_id")
  cnpj               String?
  email              String?
  phone              String?
  address            String?
  logo               String?
  website            String?
  certifications     String[]
  insurancePolicy    String?                 @map("insurance_policy")
  insuranceExpiry    DateTime?               @map("insurance_expiry")
  insuranceValue     Decimal?                @map("insurance_value") @db.Decimal(12, 2)
  managerName        String?                 @map("manager_name")
  managerPhone       String?                 @map("manager_phone")
  managerEmail       String?                 @map("manager_email")
  active             Boolean                 @default(true)
  notes              String?
  createdAt          DateTime                @default(now()) @map("created_at")
  updatedAt          DateTime                @updatedAt @map("updated_at")
  projectPermissions ProjectTeamPermission[]
  members            TeamMember[]
  company            Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("teams")
}

model TeamMember {
  id       String         @id @default(cuid())
  teamId   String         @map("team_id")
  userId   String         @map("user_id")
  role     TeamMemberRole @default(member)
  active   Boolean        @default(true)
  joinedAt DateTime       @default(now()) @map("joined_at")
  team     Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_members")
}

model ProjectTeamPermission {
  id               String    @id @default(cuid())
  projectId        String    @map("project_id")
  teamId           String    @map("team_id")
  canView          Boolean   @default(true) @map("can_view")
  canCreatePoints  Boolean   @default(true) @map("can_create_points")
  canEditPoints    Boolean   @default(true) @map("can_edit_points")
  canDeletePoints  Boolean   @default(false) @map("can_delete_points")
  canTestPoints    Boolean   @default(true) @map("can_test_points")
  canExportReports Boolean   @default(true) @map("can_export_reports")
  canViewMap       Boolean   @default(true) @map("can_view_map")
  grantedBy        String    @map("granted_by")
  grantedAt        DateTime  @default(now()) @map("granted_at")
  expiresAt        DateTime? @map("expires_at")
  notes            String?
  project          Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  team             Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([projectId, teamId])
  @@index([teamId])
  @@index([projectId])
  @@map("project_team_permissions")
}

model ProjectPublicSettings {
  id                 String    @id @default(cuid())
  projectId          String    @unique @map("project_id")
  isPublic           Boolean   @default(false) @map("is_public")
  publicToken        String    @unique @default(cuid()) @map("public_token")
  showTestHistory    Boolean   @default(true) @map("show_test_history")
  showPhotos         Boolean   @default(true) @map("show_photos")
  showTechnicalData  Boolean   @default(true) @map("show_technical_data")
  showCompanyInfo    Boolean   @default(true) @map("show_company_info")
  showTeamInfo       Boolean   @default(true) @map("show_team_info")
  showLocation       Boolean   @default(false) @map("show_location")
  showContactInfo    Boolean   @default(true) @map("show_contact_info")
  welcomeMessage     String?   @map("welcome_message")
  footerMessage      String?   @map("footer_message")
  allowReportProblem Boolean   @default(true) @map("allow_report_problem")
  reportEmail        String?   @map("report_email")
  totalViews         Int       @default(0) @map("total_views")
  lastViewedAt       DateTime? @map("last_viewed_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  createdBy          String?   @map("created_by")
  project            Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([publicToken])
  @@map("project_public_settings")
}

model PublicViewLog {
  id        String   @id @default(cuid())
  token     String
  viewedAt  DateTime @default(now()) @map("viewed_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  referer   String?  @map("referer")

  @@index([token])
  @@index([viewedAt])
  @@map("public_view_logs")
}

model PublicProblemReport {
  id            String    @id @default(cuid())
  projectId     String    @map("project_id")
  pointId       String?   @map("point_id")
  description   String
  reporterName  String?   @map("reporter_name")
  reporterEmail String?   @map("reporter_email")
  reporterPhone String?   @map("reporter_phone")
  status        String    @default("pending")
  ipAddress     String?   @map("ip_address")
  createdAt     DateTime  @default(now()) @map("created_at")
  resolvedAt    DateTime? @map("resolved_at")
  resolvedBy    String?   @map("resolved_by")
  resolution    String?

  @@index([projectId])
  @@index([status])
  @@map("public_problem_reports")
}

model NotificationSettings {
  id                  String   @id @default(cuid())
  companyId           String   @unique @map("company_id")
  emailNotifications  Boolean  @default(true) @map("email_notifications")
  inspectionReminders Boolean  @default(true) @map("inspection_reminders")
  reminderDays        Int[]    @default([30, 15, 7]) @map("reminder_days")
  failedTestAlerts    Boolean  @default(true) @map("failed_test_alerts")
  weeklyDigest        Boolean  @default(true) @map("weekly_digest")
  digestDay           Int      @default(1) @map("digest_day")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  company             Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("notification_settings")
}

model NotificationLog {
  id        String   @id @default(cuid())
  type      String
  recipient String
  subject   String
  body      String?
  sentAt    DateTime @default(now()) @map("sent_at")
  status    String
  error     String?

  @@index([sentAt])
  @@index([type])
  @@map("notification_logs")
}

// NextAuth models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Floor Plan System
model FloorPlan {
  id           String        @id @default(cuid())
  projectId    String        @map("project_id")
  name         String
  image        String        @db.Text // Base64 image
  order        Int           @default(0)
  active       Boolean       @default(true)
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  anchorPoints AnchorPoint[]

  @@index([projectId])
  @@map("floor_plans")
}

// Facade Inspection System
model FacadeInspection {
  id               String                @id @default(cuid())
  projectId        String                @map("project_id")
  name             String
  description      String?
  status           InspectionStatus      @default(in_progress)
  scheduledDate    DateTime?             @map("scheduled_date")
  startedAt        DateTime?             @map("started_at")
  completedAt      DateTime?             @map("completed_at")
  inspectorId      String?               @map("inspector_id")
  inspectorName    String?               @map("inspector_name")
  engineerId       String?               @map("engineer_id")
  createdByUserId  String                @map("created_by_user_id")
  createdAt        DateTime              @default(now()) @map("created_at")
  updatedAt        DateTime              @updatedAt @map("updated_at")
  project          Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  engineer         User?                 @relation("InspectionEngineer", fields: [engineerId], references: [id])
  createdBy        User                  @relation("InspectionCreator", fields: [createdByUserId], references: [id])
  facadeSides      FacadeSide[]
  reports          InspectionReport[]

  @@index([projectId])
  @@index([status])
  @@map("facade_inspections")
}

model FacadeSide {
  id                   String             @id @default(cuid())
  inspectionId         String             @map("inspection_id")
  name                 String
  sideType             FacadeSideType     @map("side_type")
  image                String             @db.Text // Base64 floor plan image
  dronePhotoDate       DateTime?          @map("drone_photo_date")
  weather              String?
  photographer         String?
  notes                String?
  imageWidth           Int?               @map("image_width")
  imageHeight          Int?               @map("image_height")
  availableFloors      String[]           @default([]) @map("available_floors")
  availableDivisions   String[]           @default([]) @map("available_divisions")
  order                Int                @default(0)
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")
  inspection           FacadeInspection   @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  pathologyMarkers     PathologyMarker[]

  @@index([inspectionId])
  @@map("facade_sides")
}

model PathologyCategory {
  id                String            @id @default(cuid())
  projectId         String            @map("project_id")
  name              String
  color             String            // Hex color
  severity          PathologySeverity @default(medium)
  description       String?
  active            Boolean           @default(true)
  order             Int               @default(0)
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  project           Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  pathologyMarkers  PathologyMarker[]

  @@index([projectId])
  @@map("pathology_categories")
}

model PathologyMarker {
  id            String             @id @default(cuid())
  facadeSideId  String             @map("facade_side_id")
  categoryId    String             @map("category_id")
  geometry      Json               // Can be rectangle: { type: 'rectangle', x, y, width, height } or polygon: { type: 'polygon', points: [{ x, y }, ...] }
  zIndex        Int?               @default(0) @map("z_index") // Layer control (higher = on top)
  area          Float?             // Area in square meters
  floor         String?            // Floor identification
  division      String?            // Division identification
  severity      PathologySeverity  @default(medium)
  description   String?
  observations  String?
  status        String             @default("PENDING")
  priority      Int                @default(0)
  photos        String[]           @default([]) // Array of base64 images
  createdById   String             @map("created_by_id")
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")
  facadeSide    FacadeSide         @relation(fields: [facadeSideId], references: [id], onDelete: Cascade)
  category      PathologyCategory  @relation(fields: [categoryId], references: [id])
  createdBy     User               @relation("PathologyMarkerCreator", fields: [createdById], references: [id])

  @@index([facadeSideId])
  @@index([categoryId])
  @@index([zIndex])
  @@map("pathology_markers")
}

model InspectionReport {
  id                  String           @id @default(cuid())
  facadeInspectionId  String           @map("facade_inspection_id")
  version             Int              @default(1)
  reportNumber        String           @map("report_number")
  title               String
  content             String           @db.Text
  status              String           @default("DRAFT")
  engineerId          String           @map("engineer_id")
  generatedAt         DateTime         @default(now()) @map("generated_at")
  approverId          String?          @map("approver_id")
  approvedAt          DateTime?        @map("approved_at")
  approvedBy          String?          @map("approved_by")
  rejectedAt          DateTime?        @map("rejected_at")
  rejectionReason     String?          @map("rejection_reason")
  pdfUrl              String?          @map("pdf_url")
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")
  facadeInspection    FacadeInspection @relation(fields: [facadeInspectionId], references: [id], onDelete: Cascade)
  engineer            User             @relation("ReportEngineer", fields: [engineerId], references: [id])
  approver            User?            @relation("ReportApprover", fields: [approverId], references: [id])

  @@index([facadeInspectionId])
  @@index([version])
  @@map("inspection_reports")
}

enum UserRole {
  superadmin
  company_admin
  team_admin
  technician
}

enum TeamMemberRole {
  leader
  member
  observer
}

enum SubscriptionStatus {
  active
  past_due
  canceled
  trialing
  paused
}

enum PaymentStatus {
  paid
  pending
  failed
  refunded
}

enum InspectionStatus {
  scheduled
  in_progress
  completed
  approved
  rejected
  archived
}

enum FacadeSideType {
  front
  back
  left
  right
  internal
}

enum PathologySeverity {
  low
  medium
  high
  critical
}
